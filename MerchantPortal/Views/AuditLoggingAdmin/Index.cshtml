@model Getir.MerchantPortal.Models.AuditLoggingDashboardViewModel
@inject ILocalizationService LocalizationService

@{
    ViewData["Title"] = LocalizationService.GetString("AuditLoggingCenter");
    var cutoffSuggestion = Model.Filter.StartDate?.AddDays(-1) ?? DateTime.UtcNow.AddDays(-30);
}

<div class="page-header d-flex align-items-center justify-content-between mb-4">
    <div>
        <h1 class="page-title">@LocalizationService.GetString("AuditLoggingCenter")</h1>
        <p class="text-muted mb-0">@LocalizationService.GetString("AuditLoggingCenterDescription")</p>
    </div>
</div>

@if (TempData["Success"] is string successMessage)
{
    <div class="alert alert-success">@successMessage</div>
}
@if (TempData["Error"] is string errorMessage)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">@LocalizationService.GetString("AuditFilterTitle")</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">@LocalizationService.GetString("StartDate")</label>
                <input type="date" class="form-control" name="StartDate" value="@(Model.Filter.StartDate?.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-3">
                <label class="form-label">@LocalizationService.GetString("EndDate")</label>
                <input type="date" class="form-control" name="EndDate" value="@(Model.Filter.EndDate?.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@LocalizationService.GetString("UserName")</label>
                <input type="text" class="form-control" name="UserName" value="@Model.Filter.UserName" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@LocalizationService.GetString("ActivityType")</label>
                <input type="text" class="form-control" name="ActivityType" value="@Model.Filter.ActivityType" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@LocalizationService.GetString("EntityType")</label>
                <input type="text" class="form-control" name="EntityType" value="@Model.Filter.EntityType" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@LocalizationService.GetString("Severity")</label>
                <input type="text" class="form-control" name="Severity" value="@Model.Filter.Severity" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@LocalizationService.GetString("RiskLevel")</label>
                <input type="text" class="form-control" name="RiskLevel" value="@Model.Filter.RiskLevel" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@LocalizationService.GetString("PageSize")</label>
                <input type="number" class="form-control" name="PageSize" value="@Model.Filter.PageSize" min="5" max="100" />
            </div>
            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> @LocalizationService.GetString("Filter")
                </button>
                    <a href="@Url.Action("Index", "AuditLoggingAdmin")" class="btn btn-secondary">
                    @LocalizationService.GetString("Reset")
                </a>
            </div>
        </form>
    </div>
</div>

<ul class="nav nav-tabs nav-tabs-bordered" id="auditTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="user-activity-tab" data-bs-toggle="tab" data-bs-target="#user-activity-pane" type="button" role="tab" aria-controls="user-activity-pane" aria-selected="true">
            @LocalizationService.GetString("AuditTabUserActivity")
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="system-change-tab" data-bs-toggle="tab" data-bs-target="#system-change-pane" type="button" role="tab" aria-controls="system-change-pane" aria-selected="false">
            @LocalizationService.GetString("AuditTabSystemChanges")
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="security-events-tab" data-bs-toggle="tab" data-bs-target="#security-events-pane" type="button" role="tab" aria-controls="security-events-pane" aria-selected="false">
            @LocalizationService.GetString("AuditTabSecurityEvents")
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics-pane" type="button" role="tab" aria-controls="analytics-pane" aria-selected="false">
            @LocalizationService.GetString("AuditTabAnalytics")
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports-pane" type="button" role="tab" aria-controls="reports-pane" aria-selected="false">
            @LocalizationService.GetString("AuditTabReports")
        </button>
    </li>
</ul>

<div class="tab-content pt-3" id="auditTabsContent">
    <div class="tab-pane fade show active" id="user-activity-pane" role="tabpanel" aria-labelledby="user-activity-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">@LocalizationService.GetString("AuditUserActivityTitle")</h5>
                <form asp-action="CleanupUserActivity" method="post" class="d-flex align-items-center gap-2">
                    @Html.AntiForgeryToken()
                    <input type="date" class="form-control form-control-sm" name="cutoffDate" value="@cutoffSuggestion.ToString("yyyy-MM-dd")" />
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash"></i> @LocalizationService.GetString("AuditCleanup")
                    </button>
                </form>
            </div>
            <div class="card-body p-0">
                @if (Model.UserActivities.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>@LocalizationService.GetString("Timestamp")</th>
                                    <th>@LocalizationService.GetString("User")</th>
                                    <th>@LocalizationService.GetString("ActivityType")</th>
                                    <th>@LocalizationService.GetString("Entity")</th>
                                    <th>@LocalizationService.GetString("Status")</th>
                                    <th>@LocalizationService.GetString("Details")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in Model.UserActivities)
                                {
                                    <tr>
                                        <td>@log.Timestamp.ToLocalTime().ToString("g")</td>
                                        <td>
                                            <div class="fw-semibold">@log.UserName</div>
                                            <div class="text-muted small">@log.IpAddress</div>
                                        </td>
                                        <td>@log.ActivityType</td>
                                        <td>
                                            <div>@log.EntityType</div>
                                            <div class="text-muted small">@log.EntityId</div>
                                        </td>
                                        <td>
                                            @if (log.IsSuccess)
                                            {
                                                <span class="badge bg-success-subtle text-success">@LocalizationService.GetString("Success")</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger-subtle text-danger">@LocalizationService.GetString("Failed")</span>
                                            }
                                        </td>
                                        <td>
                                            <div>@log.ActivityDescription</div>
                                            @if (!string.IsNullOrWhiteSpace(log.ErrorMessage))
                                            {
                                                <div class="text-danger small">@log.ErrorMessage</div>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="p-4 text-center text-muted">@LocalizationService.GetString("AuditNoUserActivity")</div>
                }
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="system-change-pane" role="tabpanel" aria-labelledby="system-change-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">@LocalizationService.GetString("AuditSystemChangeTitle")</h5>
                <form asp-action="CleanupSystemChanges" method="post" class="d-flex align-items-center gap-2">
                    @Html.AntiForgeryToken()
                    <input type="date" class="form-control form-control-sm" name="cutoffDate" value="@cutoffSuggestion.ToString("yyyy-MM-dd")" />
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash"></i> @LocalizationService.GetString("AuditCleanup")
                    </button>
                </form>
            </div>
            <div class="card-body p-0">
                @if (Model.SystemChanges.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>@LocalizationService.GetString("Timestamp")</th>
                                    <th>@LocalizationService.GetString("ChangeType")</th>
                                    <th>@LocalizationService.GetString("Entity")</th>
                                    <th>@LocalizationService.GetString("ChangedBy")</th>
                                    <th>@LocalizationService.GetString("Severity")</th>
                                    <th>@LocalizationService.GetString("Details")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var change in Model.SystemChanges)
                                {
                                    <tr>
                                        <td>@change.Timestamp.ToLocalTime().ToString("g")</td>
                                        <td>@change.ChangeType</td>
                                        <td>
                                            <div>@change.EntityType</div>
                                            <div class="text-muted small">@change.EntityId</div>
                                        </td>
                                        <td>
                                            <div>@change.ChangedByUserName</div>
                                            <div class="text-muted small">@change.IpAddress</div>
                                        </td>
                                        <td>@change.Severity</td>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(change.ChangeReason))
                                            {
                                                <div>@change.ChangeReason</div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(change.ChangedFields))
                                            {
                                                <div class="text-muted small">@change.ChangedFields</div>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="p-4 text-center text-muted">@LocalizationService.GetString("AuditNoSystemChanges")</div>
                }
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="security-events-pane" role="tabpanel" aria-labelledby="security-events-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">@LocalizationService.GetString("AuditSecurityEventsTitle")</h5>
                <form asp-action="CleanupSecurityEvents" method="post" class="d-flex align-items-center gap-2">
                    @Html.AntiForgeryToken()
                    <input type="date" class="form-control form-control-sm" name="cutoffDate" value="@cutoffSuggestion.ToString("yyyy-MM-dd")" />
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash"></i> @LocalizationService.GetString("AuditCleanup")
                    </button>
                </form>
            </div>
            <div class="card-body p-0">
                @if (Model.SecurityEvents.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>@LocalizationService.GetString("Timestamp")</th>
                                    <th>@LocalizationService.GetString("EventType")</th>
                                    <th>@LocalizationService.GetString("Severity")</th>
                                    <th>@LocalizationService.GetString("RiskLevel")</th>
                                    <th>@LocalizationService.GetString("Status")</th>
                                    <th>@LocalizationService.GetString("Details")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var evt in Model.SecurityEvents)
                                {
                                    <tr>
                                        <td>@evt.Timestamp.ToLocalTime().ToString("g")</td>
                                        <td>
                                            <div>@evt.EventTitle</div>
                                            <div class="text-muted small">@evt.EventType</div>
                                        </td>
                                        <td>@evt.Severity</td>
                                        <td>@evt.RiskLevel</td>
                                        <td>
                                            @if (evt.IsResolved)
                                            {
                                                <span class="badge bg-success-subtle text-success">@LocalizationService.GetString("Resolved")</span>
                                            }
                                            else if (evt.RequiresInvestigation)
                                            {
                                                <span class="badge bg-warning-subtle text-warning">@LocalizationService.GetString("RequiresInvestigation")</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary-subtle text-secondary">@LocalizationService.GetString("Open")</span>
                                            }
                                        </td>
                                        <td>
                                            <div>@evt.EventDescription</div>
                                            @if (!string.IsNullOrWhiteSpace(evt.MitigationActions))
                                            {
                                                <div class="text-muted small">@evt.MitigationActions</div>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="p-4 text-center text-muted">@LocalizationService.GetString("AuditNoSecurityEvents")</div>
                }
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="analytics-pane" role="tabpanel" aria-labelledby="analytics-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">@LocalizationService.GetString("AuditAnalyticsTitle")</h5>
            </div>
            <div class="card-body">
                @if (Model.Analytics != null)
                {
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="stat-card bg-primary-subtle text-primary">
                                <div class="stat-label">@LocalizationService.GetString("TotalEvents")</div>
                                <div class="stat-value">@Model.Analytics.Summary.TotalEvents</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-success-subtle text-success">
                                <div class="stat-label">@LocalizationService.GetString("SuccessfulEvents")</div>
                                <div class="stat-value">@Model.Analytics.Summary.SuccessfulEvents</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-danger-subtle text-danger">
                                <div class="stat-label">@LocalizationService.GetString("FailedEvents")</div>
                                <div class="stat-value">@Model.Analytics.Summary.FailedEvents</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-info-subtle text-info">
                                <div class="stat-label">@LocalizationService.GetString("UniqueUsers")</div>
                                <div class="stat-value">@Model.Analytics.Summary.UniqueUsers</div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div class="border rounded-3 p-3 h-100">
                                <h6 class="mb-3 text-muted">@LocalizationService.GetString("TopActions")</h6>
                                @if (Model.Analytics.Summary.TopActions.Any())
                                {
                                    <ul class="list-group list-group-flush">
                                        @foreach (var item in Model.Analytics.Summary.TopActions.OrderByDescending(kv => kv.Value).Take(10))
                                        {
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>@item.Key</span>
                                                <span class="badge bg-primary-subtle text-primary">@item.Value</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <div class="text-muted">@LocalizationService.GetString("NoDataAvailable")</div>
                                }
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="border rounded-3 p-3 h-100">
                                <h6 class="mb-3 text-muted">@LocalizationService.GetString("TopUsers")</h6>
                                @if (Model.Analytics.Summary.TopUsers.Any())
                                {
                                    <ul class="list-group list-group-flush">
                                        @foreach (var item in Model.Analytics.Summary.TopUsers.OrderByDescending(kv => kv.Value).Take(10))
                                        {
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>@item.Key</span>
                                                <span class="badge bg-secondary-subtle text-secondary">@item.Value</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <div class="text-muted">@LocalizationService.GetString("NoDataAvailable")</div>
                                }
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="p-4 text-center text-muted">@LocalizationService.GetString("AuditNoAnalytics")</div>
                }
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="reports-pane" role="tabpanel" aria-labelledby="reports-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">@LocalizationService.GetString("AuditReportsTitle")</h5>
                <form asp-action="CleanupReports" method="post">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash"></i> @LocalizationService.GetString("AuditCleanupExpiredReports")
                    </button>
                </form>
            </div>
            <div class="card-body p-0">
                @if (Model.Reports.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>@LocalizationService.GetString("ReportTitle")</th>
                                    <th>@LocalizationService.GetString("Period")</th>
                                    <th>@LocalizationService.GetString("Format")</th>
                                    <th>@LocalizationService.GetString("Status")</th>
                                    <th>@LocalizationService.GetString("GeneratedAt")</th>
                                    <th class="text-end">@LocalizationService.GetString("Actions")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var report in Model.Reports)
                                {
                                    <tr>
                                        <td>
                                            <div class="fw-semibold">@report.ReportTitle</div>
                                            <div class="text-muted small">@report.ReportType</div>
                                        </td>
                                        <td>
                                            <div>@report.ReportStartDate.ToLocalTime().ToString("g")</div>
                                            <div class="text-muted small">@report.ReportEndDate.ToLocalTime().ToString("g")</div>
                                        </td>
                                        <td>@report.Format</td>
                                        <td>@(report.Status ?? LocalizationService.GetString("Unknown"))</td>
                                        <td>@report.GeneratedAt.ToLocalTime().ToString("g")</td>
                                        <td class="text-end">
                                            <div class="d-inline-flex gap-2">
                                                <a asp-action="ExportReport"
                                                   asp-route-reportId="@report.Id"
                                                   asp-route-format="PDF"
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-download"></i> PDF
                                                </a>
                                                <form asp-action="RegenerateReport" method="post" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="reportId" value="@report.Id" />
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-arrow-repeat"></i> @LocalizationService.GetString("Regenerate")
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="p-4 text-center text-muted">@LocalizationService.GetString("AuditNoReports")</div>
                }
            </div>
        </div>
    </div>
</div>


