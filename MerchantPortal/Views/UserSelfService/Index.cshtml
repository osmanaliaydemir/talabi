@model Getir.MerchantPortal.Models.UserSelfServiceViewModel
@inject ILocalizationService LocalizationService

@{
    ViewData["Title"] = LocalizationService.GetString("UserSelfService");
}

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">@LocalizationService.GetString("UserSelfService")</h1>
        <p class="text-muted mb-0">@LocalizationService.GetString("UserSelfServiceDescription")</p>
    </div>
</div>

@if (TempData["Success"] is string successMessage)
{
    <div class="alert alert-success">@successMessage</div>
}
@if (TempData["Error"] is string errorMessage)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="row g-4">
    <div class="col-xl-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">@LocalizationService.GetString("Profile")</h5>
            </div>
            <div class="card-body">
                <form asp-action="UpdateProfile" method="post" class="row g-3">
                    @Html.AntiForgeryToken()
                    <div class="col-12">
                        <label asp-for="ProfileForm.FirstName" class="form-label">@LocalizationService.GetString("FirstName")</label>
                        <input asp-for="ProfileForm.FirstName" class="form-control" />
                        <span asp-validation-for="ProfileForm.FirstName" class="text-danger"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="ProfileForm.LastName" class="form-label">@LocalizationService.GetString("LastName")</label>
                        <input asp-for="ProfileForm.LastName" class="form-control" />
                        <span asp-validation-for="ProfileForm.LastName" class="text-danger"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="ProfileForm.PhoneNumber" class="form-label">@LocalizationService.GetString("PhoneNumber")</label>
                        <input asp-for="ProfileForm.PhoneNumber" class="form-control" />
                        <span asp-validation-for="ProfileForm.PhoneNumber" class="text-danger"></span>
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> @LocalizationService.GetString("Save")
                        </button>
                    </div>
                </form>
                @if (Model.Profile != null)
                {
                    <div class="mt-4">
                        <div class="text-muted small">@LocalizationService.GetString("Email")</div>
                        <div class="fw-semibold">@Model.Profile.Email</div>
                        <div class="text-muted small mt-2">@LocalizationService.GetString("AccountCreated")</div>
                        <div>@Model.Profile.CreatedAt.ToLocalTime().ToString("f")</div>
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="col-xl-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">@LocalizationService.GetString("NotificationPreferences")</h5>
            </div>
            <div class="card-body">
                <form asp-action="UpdateNotificationPreferences" method="post">
                    @Html.AntiForgeryToken()
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="NotificationForm.EmailEnabled" />
                                <label class="form-check-label" asp-for="NotificationForm.EmailEnabled">@LocalizationService.GetString("EmailEnabled")</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="NotificationForm.EmailOrderUpdates" />
                                <label class="form-check-label" asp-for="NotificationForm.EmailOrderUpdates">@LocalizationService.GetString("EmailOrderUpdates")</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="NotificationForm.EmailPromotions" />
                                <label class="form-check-label" asp-for="NotificationForm.EmailPromotions">@LocalizationService.GetString("EmailPromotions")</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="NotificationForm.SmsEnabled" />
                                <label class="form-check-label" asp-for="NotificationForm.SmsEnabled">@LocalizationService.GetString("SmsEnabled")</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="NotificationForm.SmsOrderUpdates" />
                                <label class="form-check-label" asp-for="NotificationForm.SmsOrderUpdates">@LocalizationService.GetString("SmsOrderUpdates")</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="NotificationForm.SmsPromotions" />
                                <label class="form-check-label" asp-for="NotificationForm.SmsPromotions">@LocalizationService.GetString("SmsPromotions")</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="NotificationForm.PushEnabled" />
                                <label class="form-check-label" asp-for="NotificationForm.PushEnabled">@LocalizationService.GetString("PushEnabled")</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="NotificationForm.SoundEnabled" />
                                <label class="form-check-label" asp-for="NotificationForm.SoundEnabled">@LocalizationService.GetString("SoundEnabled")</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="NotificationForm.DesktopNotifications" />
                                <label class="form-check-label" asp-for="NotificationForm.DesktopNotifications">@LocalizationService.GetString("DesktopNotifications")</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">@LocalizationService.GetString("NotificationSound")</label>
                            <input asp-for="NotificationForm.NotificationSound" class="form-control" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">@LocalizationService.GetString("QuietStartTime")</label>
                            <input asp-for="NotificationForm.QuietStartTime" class="form-control" type="time" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">@LocalizationService.GetString("QuietEndTime")</label>
                            <input asp-for="NotificationForm.QuietEndTime" class="form-control" type="time" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">@LocalizationService.GetString("Language")</label>
                            <input asp-for="NotificationForm.Language" class="form-control" />
                        </div>
                        <div class="col-md-4 d-flex align-items-center">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" asp-for="NotificationForm.NewOrderNotifications" />
                                <label class="form-check-label" asp-for="NotificationForm.NewOrderNotifications">@LocalizationService.GetString("NewOrderNotifications")</label>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-center">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" asp-for="NotificationForm.StatusChangeNotifications" />
                                <label class="form-check-label" asp-for="NotificationForm.StatusChangeNotifications">@LocalizationService.GetString("StatusChangeNotifications")</label>
                            </div>
                        </div>
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> @LocalizationService.GetString("Save")
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-xl-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">@LocalizationService.GetString("Addresses")</h5>
            </div>
            <div class="card-body">
                <form asp-action="CreateAddress" method="post" class="row g-3 mb-4">
                    @Html.AntiForgeryToken()
                    <div class="col-12">
                        <label class="form-label">@LocalizationService.GetString("AddressTitle")</label>
                        <input asp-for="AddressForm.Title" class="form-control" />
                        <span asp-validation-for="AddressForm.Title" class="text-danger"></span>
                    </div>
                    <div class="col-12">
                        <label class="form-label">@LocalizationService.GetString("FullAddress")</label>
                        <textarea asp-for="AddressForm.FullAddress" class="form-control" rows="2"></textarea>
                        <span asp-validation-for="AddressForm.FullAddress" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@LocalizationService.GetString("City")</label>
                        <input asp-for="AddressForm.City" class="form-control" />
                        <span asp-validation-for="AddressForm.City" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@LocalizationService.GetString("District")</label>
                        <input asp-for="AddressForm.District" class="form-control" />
                        <span asp-validation-for="AddressForm.District" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@LocalizationService.GetString("Latitude")</label>
                        <input asp-for="AddressForm.Latitude" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@LocalizationService.GetString("Longitude")</label>
                        <input asp-for="AddressForm.Longitude" class="form-control" />
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> @LocalizationService.GetString("AddAddress")
                        </button>
                    </div>
                </form>

                @if (Model.Addresses.Any())
                {
                    foreach (var address in Model.Addresses.OrderByDescending(a => a.CreatedAt))
                    {
                        <div class="border rounded-3 p-3 mb-3">
                            <form asp-action="UpdateAddress" method="post" class="row g-2 mb-2">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="Id" value="@address.Id" />
                                <div class="col-md-6">
                                    <label class="form-label">@LocalizationService.GetString("AddressTitle")</label>
                                    <input name="Title" class="form-control" value="@address.Title" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">@LocalizationService.GetString("FullAddress")</label>
                                    <input name="FullAddress" class="form-control" value="@address.FullAddress" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">@LocalizationService.GetString("City")</label>
                                    <input name="City" class="form-control" value="@address.City" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">@LocalizationService.GetString("District")</label>
                                    <input name="District" class="form-control" value="@address.District" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">@LocalizationService.GetString("Latitude")</label>
                                    <input name="Latitude" class="form-control" value="@address.Latitude.ToString(System.Globalization.CultureInfo.InvariantCulture)" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">@LocalizationService.GetString("Longitude")</label>
                                    <input name="Longitude" class="form-control" value="@address.Longitude.ToString(System.Globalization.CultureInfo.InvariantCulture)" />
                                </div>
                                <div class="col-12 text-end mt-2">
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-save"></i> @LocalizationService.GetString("Save")
                                    </button>
                                </div>
                            </form>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    @if (address.IsDefault)
                                    {
                                        <span class="badge bg-success-subtle text-success">@LocalizationService.GetString("Default")</span>
                                    }
                                </div>
                                <div class="d-inline-flex gap-2">
                                    <form asp-action="SetDefaultAddress" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="addressId" value="@address.Id" />
                                        <button type="submit" class="btn btn-sm btn-outline-success" @(address.IsDefault ? "disabled" : null)>
                                            <i class="bi bi-star"></i> @LocalizationService.GetString("SetDefault")
                                        </button>
                                    </form>
                                    <form asp-action="DeleteAddress" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="addressId" value="@address.Id" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i> @LocalizationService.GetString("Delete")
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-muted text-center">@LocalizationService.GetString("NoAddressesFound")</div>
                }
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">@LocalizationService.GetString("Favorites")</h5>
                <span class="badge bg-secondary-subtle text-secondary">@Model.Favorites?.TotalCount ?? 0</span>
            </div>
            <div class="card-body">
                @if (Model.Favorites?.Items.Any() == true)
                {
                    <div class="row g-3">
                        @foreach (var fav in Model.Favorites.Items)
                        {
                            <div class="col-md-6">
                                <div class="border rounded-3 p-3 h-100 d-flex flex-column">
                                    <h6 class="mb-1">@fav.ProductName</h6>
                                    <div class="text-muted small">@fav.MerchantName</div>
                                    <div class="fw-semibold mt-2">@fav.Price.ToString("C2")</div>
                                    <div class="mt-auto d-flex justify-content-between align-items-center">
                                        <small class="text-muted">@fav.AddedAt.ToLocalTime().ToString("g")</small>
                                        <form asp-action="RemoveFavorite" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="productId" value="@fav.ProductId" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-heartbreak"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-muted text-center">@LocalizationService.GetString("NoFavoritesFound")</div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">@LocalizationService.GetString("RecentOrders")</h5>
                <span class="badge bg-secondary-subtle text-secondary">@Model.Orders?.TotalCount ?? 0</span>
            </div>
            <div class="card-body p-0">
                @if (Model.Orders?.Items.Any() == true)
                {
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>@LocalizationService.GetString("OrderNumber")</th>
                                    <th>@LocalizationService.GetString("Merchant")</th>
                                    <th>@LocalizationService.GetString("Status")</th>
                                    <th>@LocalizationService.GetString("Total")</th>
                                    <th>@LocalizationService.GetString("CreatedAt")</th>
                                    <th class="text-end">@LocalizationService.GetString("Actions")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in Model.Orders.Items)
                                {
                                    <tr>
                                        <td>@order.OrderNumber</td>
                                        <td>@order.MerchantName</td>
                                        <td>
                                            <span class="badge bg-primary-subtle text-primary">@LocalizationService.GetString(order.Status)</span>
                                        </td>
                                        <td>@order.Total.ToString("C2")</td>
                                        <td>@order.CreatedAt.ToLocalTime().ToString("g")</td>
                                        <td class="text-end">
                                            <a asp-action="OrderDetails" asp-route-id="@order.Id" class="btn btn-sm btn-outline-secondary">
                                                @LocalizationService.GetString("View")
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="p-4 text-center text-muted">@LocalizationService.GetString("NoOrdersFound")</div>
                }
            </div>
        </div>
    </div>
    <div class="col-xl-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">@LocalizationService.GetString("RecentLocations")</h5>
            </div>
            <div class="card-body">
                <form asp-action="SaveLocation" method="post" class="row g-2 mb-3">
                    @Html.AntiForgeryToken()
                    <div class="col-6">
                        <label class="form-label">@LocalizationService.GetString("Latitude")</label>
                        <input name="latitude" class="form-control" required />
                    </div>
                    <div class="col-6">
                        <label class="form-label">@LocalizationService.GetString("Longitude")</label>
                        <input name="longitude" class="form-control" required />
                    </div>
                    <div class="col-12">
                        <label class="form-label">@LocalizationService.GetString("Address")</label>
                        <input name="address" class="form-control" />
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-geo-alt"></i> @LocalizationService.GetString("SaveLocation")
                        </button>
                    </div>
                </form>

                @if (Model.LocationHistory.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var location in Model.LocationHistory)
                        {
                            <li class="list-group-item">
                                <div class="fw-semibold">@location.Address ?? $"{location.Latitude:F4}, {location.Longitude:F4}"</div>
                                <div class="text-muted small">@location.CreatedAt.ToLocalTime().ToString("g")</div>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="text-muted text-center">@LocalizationService.GetString("NoLocationHistory")</div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}


