@model Getir.MerchantPortal.Models.DashboardViewModel
@inject ILocalizationService LocalizationService
@using Getir.MerchantPortal.Services
@{
    ViewData["Title"] = LocalizationService.GetString("Dashboard");
    var stats = Model.Stats;
    var performance = Model.Performance;
    var recentOrders = Model.RecentOrders ?? new List<RecentOrderResponse>();
    var topProducts = Model.TopProducts ?? new List<TopProductResponse>();
    var stockSummary = Model.StockSummary;
}

@section Styles {
    <link rel="stylesheet" href="~/css/dashboard-modern.css" />
}


<!-- Welcome Banner -->
<div class="quick-stats-banner fade-in mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2><i class="fas fa-store me-2"></i>@LocalizationService.GetString("Welcome"), @User.Identity?.Name!</h2>
            <p class="mb-0">@LocalizationService.GetString("TodayStats")</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <div class="d-flex align-items-center justify-content-md-end gap-2">
                <i class="fas fa-clock fa-2x opacity-75"></i>
                <div>
                    <div class="small opacity-75">@LocalizationService.GetString("LastUpdate")</div>
                    <div id="lastUpdate" class="fw-bold">@DateTime.Now.ToString("HH:mm")</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern Stat Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="stat-card-gradient primary fade-in" style="animation-delay: 0.1s;">
            <div class="gradient-bg"></div>
            <div class="stat-icon-modern primary">
                <i class="fas fa-lira-sign"></i>
            </div>
            <div class="stat-label">@LocalizationService.GetString("TodayRevenue")</div>
            <div class="stat-value">₺@(stats?.TodayRevenue.ToString("N2") ?? "0")</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>@(stats?.TodayOrders ?? 0) @LocalizationService.GetString("OrdersCount")</span>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="stat-card-gradient warning fade-in" style="animation-delay: 0.2s;">
            <div class="gradient-bg"></div>
            <div class="stat-icon-modern warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-label">@LocalizationService.GetString("PendingOrders")</div>
            <div class="stat-value">@(stats?.PendingOrders ?? 0)</div>
            <div class="stat-change @((stats?.PendingOrders ?? 0) > 0 ? "negative" : "neutral")">
                <i class="fas fa-exclamation-circle"></i>
                <span>@LocalizationService.GetString("PendingAction")</span>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="stat-card-gradient success fade-in" style="animation-delay: 0.3s;">
            <div class="gradient-bg"></div>
            <div class="stat-icon-modern success">
                <i class="fas fa-box"></i>
            </div>
            <div class="stat-label">@LocalizationService.GetString("ActiveProducts")</div>
            <div class="stat-value">@(stats?.ActiveProducts ?? 0)</div>
            <div class="stat-change positive">
                <i class="fas fa-check-circle"></i>
                <span>@LocalizationService.GetString("OnSale")</span>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="stat-card-gradient info fade-in" style="animation-delay: 0.4s;">
            <div class="gradient-bg"></div>
            <div class="stat-icon-modern info">
                <i class="fas fa-star"></i>
            </div>
            <div class="stat-label">@LocalizationService.GetString("Review")</div>
            <div class="stat-value">@(stats?.AverageRating.ToString("N1") ?? "0.0")</div>
            <div class="stat-change neutral">
                <i class="fas fa-users"></i>
                <span>@(stats?.TotalReviews ?? 0) @LocalizationService.GetString("Reviews")</span>
            </div>
        </div>
    </div>
</div>

<!-- Performance Cards & Stock Alerts -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-4">
        <div class="performance-card fade-in" style="animation-delay: 0.5s;">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-coins"></i>
                    @LocalizationService.GetString("AverageOrderValue")
                </div>
            </div>
            <div class="metric-row">
                <div>
                    <div class="metric-label">@LocalizationService.GetString("AverageOrderValue")</div>
                    <div class="metric-value text-primary">
                        ₺@(performance?.AverageOrderValue.ToString("N2") ?? "0")
                    </div>
                </div>
                <div>
                    <div class="metric-label">@LocalizationService.GetString("TotalOrders")</div>
                    <div class="metric-value text-success">
                        @(stats?.TotalOrders ?? 0)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-4">
        <div class="performance-card fade-in" style="animation-delay: 0.6s;">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-stream"></i>
                    @LocalizationService.GetString("MerchantPerformance")
                </div>
            </div>
            <div class="metric-row">
                <div>
                    <div class="metric-label">@LocalizationService.GetString("OrdersPerDay")</div>
                    <div class="metric-value text-info">
                        @(performance?.OrdersPerDay ?? 0)
                    </div>
                </div>
                <div>
                    <div class="metric-label">@LocalizationService.GetString("AveragePreparationTime")</div>
                    <div class="metric-value text-warning">
                        @(performance?.AveragePreparationTime ?? 0) dk
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-12 col-lg-4">
        <div class="performance-card fade-in" style="animation-delay: 0.7s;">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-percentage"></i>
                    @LocalizationService.GetString("CompletionRate")
                </div>
            </div>
            <div class="metric-row">
                <div>
                    <div class="metric-label">@LocalizationService.GetString("CompletionRate")</div>
                    <div class="metric-value text-success">
                        @(performance != null ? performance.CompletionRate.ToString("N1") : "0")%
                    </div>
                </div>
                <div>
                    <div class="metric-label">@LocalizationService.GetString("CustomerSatisfaction")</div>
                    <div class="metric-value text-primary">
                        @(performance?.CustomerSatisfactionScore.ToString("N1") ?? "0")
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Alert Widget -->
    <div class="col-md-12 col-lg-4">
        <div class="performance-card fade-in" style="animation-delay: 0.7s;">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-boxes"></i>
                    @LocalizationService.GetString("StockStatus")
                </div>
                <a href="/Stock/Alerts" class="btn btn-sm btn-outline-primary">
                    @LocalizationService.GetString("Details") <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            
            @if (stockSummary != null && stockSummary.ActiveAlerts > 0)
            {
                <div class="stock-alert-summary">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <strong>@stockSummary.ActiveAlerts</strong> @LocalizationService.GetString("ActiveAlerts")
                        </span>
                    </div>
                    <div class="row g-2 mt-2">
                        @if (stockSummary.LowStockItems > 0)
                        {
                            <div class="col-6">
                                <div class="alert alert-warning mb-0 py-2 px-2 d-flex align-items-center">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    <div>
                                        <small class="d-block">@LocalizationService.GetString("LowStock")</small>
                                        <strong>@stockSummary.LowStockItems</strong>
                                    </div>
                                </div>
                            </div>
                        }
                        @if (stockSummary.OutOfStockItems > 0)
                        {
                            <div class="col-6">
                                <div class="alert alert-danger mb-0 py-2 px-2 d-flex align-items-center">
                                    <i class="fas fa-times-circle me-2"></i>
                                    <div>
                                        <small class="d-block">@LocalizationService.GetString("OutOfStock")</small>
                                        <strong>@stockSummary.OutOfStockItems</strong>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="text-center py-3">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <p class="text-muted mb-0 small">@LocalizationService.GetString("StockNormal")</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Analytics Charts -->
<div class="row g-4 mb-4">
    <!-- Sales Line Chart -->
    <div class="col-lg-8">
        <div class="chart-container-modern fade-in" style="animation-delay: 0.9s;">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    @LocalizationService.GetString("SalesTrend") (@LocalizationService.GetString("Last30Days"))
                </div>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary active" data-period="30">@LocalizationService.GetString("Days30")</button>
                    <button type="button" class="btn btn-outline-secondary" data-period="7">@LocalizationService.GetString("Days7")</button>
                </div>
            </div>
            <div class="p-3">
                <canvas id="salesChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <!-- Orders Bar Chart -->
    <div class="col-lg-4">
        <div class="chart-container-modern fade-in" style="animation-delay: 1.0s;">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    @LocalizationService.GetString("OrderStatus")
                </div>
            </div>
            <div class="p-3">
                <canvas id="ordersChart" height="120"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Category Pie Chart & Top Products -->
<div class="row g-4 mb-4">
    <!-- Category Pie Chart -->
    <div class="col-lg-5">
        <div class="chart-container-modern fade-in" style="animation-delay: 1.1s;">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    @LocalizationService.GetString("CategoryDistribution") (@LocalizationService.GetString("Revenue"))
                </div>
            </div>
            <div class="p-3">
                <canvas id="categoryChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Products (existing, moved here) -->
    <div class="col-lg-7">
        <div class="chart-container-modern fade-in" style="animation-delay: 1.2s;">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-fire"></i>
                    @LocalizationService.GetString("TopSellers")
                </div>
                <a href="/Products/Index" class="btn btn-sm btn-outline-primary">
                    @LocalizationService.GetString("ViewAll") <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            
            @if (topProducts.Any())
            {
                <div class="d-flex flex-column gap-3 p-3">
                    @for (var i = 0; i < Math.Min(5, topProducts.Count); i++)
                    {
                        var product = topProducts[i];
                        var medalColor = i switch
                        {
                            0 => "text-warning",
                            1 => "text-secondary",
                            2 => "text-danger",
                            _ => "text-muted"
                        };
                        
                        <div class="product-card-mini">
                            <div class="position-relative">
                                <img src="@(product.ImageUrl ?? "/images/product-placeholder.png")" 
                                     alt="@product.Name" 
                                     class="product-img-mini"
                                     onerror="this.src='/images/product-placeholder.png'">
                                <div class="position-absolute top-0 start-0 @medalColor" style="margin: -8px 0 0 -8px; font-size: 1.5rem;">
                                    <i class="fas fa-medal"></i>
                                </div>
                            </div>
                            <div class="product-info">
                                <div class="product-name">@product.Name</div>
                                <div class="product-sales">
                                    <i class="fas fa-shopping-cart me-1"></i>
                                    <span class="fw-bold">@product.OrderCount</span> @LocalizationService.GetString("Sales")
                                    <span class="text-muted mx-2">•</span>
                                    <span class="text-success fw-bold">₺@product.TotalRevenue.ToString("N2")</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="text-success fw-bold">₺@product.TotalRevenue.ToString("N2")</div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <p class="text-muted">@LocalizationService.GetString("NoSalesYet")</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Recent Orders -->
<div class="row g-4">
    <div class="col-12">
        <div class="chart-container-modern fade-in" style="animation-delay: 1.3s;">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-shopping-bag"></i>
                    @LocalizationService.GetString("RecentOrders")
                </div>
                <a href="/Orders/Index" class="btn btn-sm btn-outline-primary">
                    @LocalizationService.GetString("ViewAll") <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            
            @if (recentOrders.Any())
            {
                <div class="table-responsive">
                    <table class="table table-modern table-hover mb-0">
                        <thead>
                            <tr>
                                <th>@LocalizationService.GetString("ORDER_NO")</th>
                                <th>@LocalizationService.GetString("CUSTOMER")</th>
                                <th>@LocalizationService.GetString("AMOUNT")</th>
                                <th>@LocalizationService.GetString("STATUS")</th>
                                <th>@LocalizationService.GetString("TIME")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in recentOrders.Take(5))
                            {
                                <tr>
                                    <td>
                                        <span class="fw-bold text-primary">#@order.OrderNumber</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-gradient-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.875rem;">
                                                @(order.CustomerName?.Substring(0, 1).ToUpper() ?? "?")
                                            </div>
                                            <span>@order.CustomerName</span>
                                        </div>
                                    </td>
                                    <td class="fw-bold">₺@order.TotalAmount.ToString("N2")</td>
                                    <td>
                                        @{
                                            var badgeClass = order.Status switch
                                            {
                                                "Pending" => "warning",
                                                "Confirmed" => "info",
                                                "Preparing" => "primary",
                                                "Ready" => "success",
                                                "Delivered" => "success",
                                                "Cancelled" => "danger",
                                                _ => "secondary"
                                            };

                                            var statusText = order.Status switch
                                            {
                                                "Pending" => LocalizationService.GetString("Pending"),
                                                "Confirmed" => LocalizationService.GetString("Confirmed"),
                                                "Preparing" => LocalizationService.GetString("Preparing"),
                                                "Ready" => LocalizationService.GetString("Ready"),
                                                "Delivered" => LocalizationService.GetString("Delivered"),
                                                "Cancelled" => LocalizationService.GetString("Cancelled"),
                                                _ => order.Status
                                            };
                                        }
                                        <span class="badge-modern @badgeClass">
                                            <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                                            @statusText
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            <i class="far fa-clock me-1"></i>
                                            @order.CreatedAt.ToString("dd MMM, HH:mm")
                                        </small>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                    <p class="text-muted">@LocalizationService.GetString("NoOrdersYetShort")</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script src="~/js/signalr-helper.js"></script>
    <script>
        // Initialize SignalR connection
        initializeSignalR('@Url.Content("~/")');
    </script>
    <script src="~/js/modules/dashboard/dashboard.js" asp-append-version="true"></script>
}
