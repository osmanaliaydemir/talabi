@model Getir.MerchantPortal.Models.RateLimitAdminViewModel
@inject ILocalizationService LocalizationService

@{
    ViewData["Title"] = LocalizationService.GetString("RateLimitAdmin");
}

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">@LocalizationService.GetString("RateLimitAdmin")</h1>
        <p class="text-muted mb-0">@LocalizationService.GetString("RateLimitAdminDescription")</p>
    </div>
    <form method="get" class="row g-2 align-items-center">
        <div class="col-auto">
            <label class="form-label mb-0">@LocalizationService.GetString("Endpoint")</label>
        </div>
        <div class="col-auto">
            <select name="httpMethod" class="form-select">
                @{
                    var methods = new[] { "GET", "POST", "PUT", "DELETE" };
                    foreach (var method in methods)
                    {
                        <option value="@method" selected="@(string.Equals(method, Model.HttpMethodQuery, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@method</option>
                    }
                }
            </select>
        </div>
        <div class="col-auto">
            <input type="text" name="endpoint" class="form-control" placeholder="/api/orders" value="@Model.EndpointQuery" />
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i> @LocalizationService.GetString("CheckStatus")
            </button>
        </div>
    </form>
</div>

@if (TempData["Success"] is string successMessage)
{
    <div class="alert alert-success">@successMessage</div>
}
@if (TempData["Error"] is string errorMessage)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">@LocalizationService.GetString("RateLimitRules")</h5>
        <span class="badge bg-secondary-subtle text-secondary">@Model.Rules.Count</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>@LocalizationService.GetString("Name")</th>
                    <th>@LocalizationService.GetString("Type")</th>
                    <th>@LocalizationService.GetString("Limit")</th>
                    <th>@LocalizationService.GetString("Action")</th>
                    <th>@LocalizationService.GetString("Status")</th>
                    <th class="text-end">@LocalizationService.GetString("Actions")</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var rule in Model.Rules.OrderByDescending(r => r.IsActive).ThenBy(r => r.Priority))
                {
                    <tr>
                        <td>
                            <strong>@rule.Name</strong>
                            <div class="text-muted small">@rule.Description</div>
                            @if (!string.IsNullOrWhiteSpace(rule.Endpoint))
                            {
                                <div class="text-muted small">@rule.HttpMethod ?? "ANY" â€¢ <code>@rule.Endpoint</code></div>
                            }
                        </td>
                        <td>@rule.Type</td>
                        <td>@rule.RequestLimit / @rule.Period</td>
                        <td>@rule.Action</td>
                        <td>
                            @if (rule.IsActive)
                            {
                                <span class="badge bg-success-subtle text-success">@LocalizationService.GetString("Active")</span>
                            }
                            else
                            {
                                <span class="badge bg-warning-subtle text-warning">@LocalizationService.GetString("Inactive")</span>
                            }
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                @if (rule.IsActive)
                                {
                                    <form asp-action="Disable" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@rule.Id" />
                                        <button type="submit" class="btn btn-outline-warning">
                                            <i class="bi bi-pause-circle"></i> @LocalizationService.GetString("Disable")
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <form asp-action="Enable" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@rule.Id" />
                                        <button type="submit" class="btn btn-outline-success">
                                            <i class="bi bi-play-circle"></i> @LocalizationService.GetString("Enable")
                                        </button>
                                    </form>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (Model.Status != null)
{
    <div class="row g-4 mb-4">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">@LocalizationService.GetString("RateLimitStatus")</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-1">@LocalizationService.GetString("Endpoint")</p>
                    <p class="fw-semibold">@Model.EndpointQuery ?? "-"</p>

                    <p class="text-muted mb-1">@LocalizationService.GetString("HttpMethod")</p>
                    <p class="fw-semibold">@Model.HttpMethodQuery</p>

                    <p class="text-muted mb-1">@LocalizationService.GetString("RemainingRequests")</p>
                    <p class="fw-semibold">@Model.Status.RemainingRequests</p>

                    <p class="text-muted mb-1">@LocalizationService.GetString("RateLimitAction")</p>
                    <p class="fw-semibold">@Model.Status.Action ?? "-"</p>

                    @if (Model.Status.IsLimitExceeded)
                    {
                        <div class="alert alert-warning mt-3">
                            <strong>@LocalizationService.GetString("LimitExceeded")</strong>
                            <div>@Model.Status.Message</div>
                            @if (Model.Status.RetryAfter.HasValue)
                            {
                                <div class="small mt-2">@LocalizationService.GetString("RetryAfter") @Model.Status.RetryAfter.Value.ToLocalTime()</div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success mt-3 mb-0">
                            @LocalizationService.GetString("LimitNotExceeded")
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">@LocalizationService.GetString("RecentRateLimitLogs")</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>@LocalizationService.GetString("Date")</th>
                                <th>@LocalizationService.GetString("User")</th>
                                <th>@LocalizationService.GetString("Endpoint")</th>
                                <th>@LocalizationService.GetString("Result")</th>
                                <th>@LocalizationService.GetString("Requests")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.LogSearch?.Logs.Any() == true)
                            {
                                foreach (var log in Model.LogSearch.Logs)
                                {
                                    <tr>
                                        <td>@log.RequestTime.ToLocalTime().ToString("g")</td>
                                        <td>@(log.UserName ?? log.UserId ?? "-")</td>
                                        <td><code>@log.Endpoint</code></td>
                                        <td>
                                            @if (log.IsLimitExceeded)
                                            {
                                                <span class="badge bg-danger-subtle text-danger">@LocalizationService.GetString("LimitExceeded")</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success-subtle text-success">@LocalizationService.GetString("Allowed")</span>
                                            }
                                        </td>
                                        <td>@log.RequestCount / @log.RequestLimit</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-3">
                                        @LocalizationService.GetString("NoRateLimitLogs")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

