@inject ILocalizationService LocalizationService
@{
    ViewData["Title"] = LocalizationService.GetString("Settlements");
}

@section Styles {
    <style>
        .settlement-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .summary-box {
            background: #f8f9fa;
            border-left: 4px solid #5D3EBC;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .summary-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            padding-top: 1rem;
            margin-top: 0.5rem;
            border-top: 2px solid #5D3EBC;
        }
    </style>
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-file-invoice-dollar me-2"></i>@LocalizationService.GetString("SettlementReports")</h2>
        <p class="text-muted mb-0">@LocalizationService.GetString("IncomeCommissionNet")</p>
    </div>
    <div>
        <a href="/Payments/Index" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-1"></i> @LocalizationService.GetString("GoBack")
        </a>
    </div>
</div>

<!-- Date Range Selector -->
<div class="settlement-card">
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">@LocalizationService.GetString("StartDate")</label>
            <input type="date" class="form-control" id="settlementStartDate" />
        </div>
        <div class="col-md-3">
            <label class="form-label">@LocalizationService.GetString("EndDate")</label>
            <input type="date" class="form-control" id="settlementEndDate" />
        </div>
        <div class="col-md-3">
            <label class="form-label">@LocalizationService.GetString("QuickSelect")</label>
            <select class="form-select" id="quickSelect" onchange="selectQuickPeriod()">
                <option value="">@LocalizationService.GetString("CustomDate")</option>
                <option value="today">@LocalizationService.GetString("Today")</option>
                <option value="week">@LocalizationService.GetString("ThisWeek")</option>
                <option value="month" selected>@LocalizationService.GetString("ThisMonth")</option>
                <option value="lastMonth">@LocalizationService.GetString("LastMonth")</option>
                <option value="quarter">@LocalizationService.GetString("ThisQuarter")</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="loadSettlementReport()">
                <i class="fas fa-calculator me-1"></i> @LocalizationService.GetString("GenerateReport")
            </button>
        </div>
    </div>
</div>

<!-- Settlement Summary -->
<div class="settlement-card" id="settlementSummary" style="display: none;">
    <h5 class="mb-4">
        <i class="fas fa-file-invoice me-2"></i>
        @LocalizationService.GetString("SettlementSummary")
        <small class="text-muted ms-2" id="reportPeriod"></small>
    </h5>

    <div class="summary-box">
        <div class="summary-row">
            <span>@LocalizationService.GetString("TotalRevenue")</span>
            <span class="text-success fw-bold" id="summaryRevenue">₺0</span>
        </div>
        <div class="summary-row">
            <span>@LocalizationService.GetString("CommissionWithRate") (%15)</span>
            <span class="text-danger" id="summaryCommission">₺0</span>
        </div>
        <div class="summary-row">
            <span>@LocalizationService.GetString("NetEarnings")</span>
            <span class="text-primary" style="font-size: 1.25rem;" id="summaryNet">₺0</span>
        </div>
    </div>

    <div class="row g-3 mt-3">
        <div class="col-md-6">
<div class="alert alert-info">
                <i class="fas fa-shopping-cart me-2"></i>
                @LocalizationService.GetString("TotalOrders"): <strong id="summaryOrders">0</strong>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                @LocalizationService.GetString("Completed"): <strong id="summaryCompleted">0</strong>
            </div>
        </div>
    </div>
</div>

<!-- Daily Breakdown -->
<div class="settlement-card" id="dailyBreakdown" style="display: none;">
    <h5 class="mb-3">
        <i class="fas fa-calendar-alt me-2"></i>
        @LocalizationService.GetString("DailyBreakdown")
    </h5>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                    <th>@LocalizationService.GetString("Date")</th>
                    <th class="text-end">@LocalizationService.GetString("Revenue")</th>
                    <th class="text-end">@LocalizationService.GetString("Commission")</th>
                    <th class="text-end">@LocalizationService.GetString("Net")</th>
                    <th class="text-end">@LocalizationService.GetString("Orders")</th>
                    </tr>
                </thead>
            <tbody id="dailyBreakdownTable">
                <!-- Will be populated by JS -->
                </tbody>
            <tfoot>
                <tr class="fw-bold">
                    <td>@LocalizationService.GetString("TOTAL_UPPER")</td>
                    <td class="text-end text-success" id="totalRevenueFoot">₺0</td>
                    <td class="text-end text-danger" id="totalCommissionFoot">₺0</td>
                    <td class="text-end text-primary" id="totalNetFoot">₺0</td>
                    <td class="text-end" id="totalOrdersFoot">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
</div>

@section Scripts {
    <script>
        // Set default to current month
        document.addEventListener('DOMContentLoaded', function() {
            selectQuickPeriod();
        });

        function selectQuickPeriod() {
            const select = document.getElementById('quickSelect');
            const value = select.value || 'month';
            const now = new Date();
            let startDate, endDate;

            switch(value) {
                case 'today':
                    startDate = endDate = now;
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                    endDate = new Date();
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date();
                    break;
                case 'lastMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date();
                    break;
                default:
                    return; // Custom date
            }

            document.getElementById('settlementStartDate').valueAsDate = startDate;
            document.getElementById('settlementEndDate').valueAsDate = endDate;

            if (value) {
                loadSettlementReport();
            }
        }

        async function loadSettlementReport() {
            const startDate = document.getElementById('settlementStartDate').value;
            const endDate = document.getElementById('settlementEndDate').value;

            if (!startDate || !endDate) {
                alert('Lütfen tarih aralığı seçin');
                return;
            }

            try {
                const response = await fetch(`/Payments/GetSettlementReport?startDate=${startDate}&endDate=${endDate}`);
                const result = await response.json();

                if (!result.success) {
                    console.error('Failed to load settlement report');
                    return;
                }

                const report = result.data;

                // Update summary
                document.getElementById('reportPeriod').textContent = 
                    `(${new Date(startDate).toLocaleDateString('tr-TR')} - ${new Date(endDate).toLocaleDateString('tr-TR')})`;
                document.getElementById('summaryRevenue').textContent = `₺${report.totalRevenue.toFixed(2)}`;
                document.getElementById('summaryCommission').textContent = `₺${report.totalCommission.toFixed(2)}`;
                document.getElementById('summaryNet').textContent = `₺${report.netAmount.toFixed(2)}`;
                document.getElementById('summaryOrders').textContent = report.totalOrders;
                document.getElementById('summaryCompleted').textContent = report.completedOrders;

                // Show sections
                document.getElementById('settlementSummary').style.display = 'block';
                document.getElementById('dailyBreakdown').style.display = 'block';

                // Render daily breakdown
                const tbody = document.getElementById('dailyBreakdownTable');
                tbody.innerHTML = '';
                report.dailyBreakdown.forEach(day => {
                    const row = `
                        <tr>
                            <td>${new Date(day.date).toLocaleDateString('tr-TR', { weekday: 'short', day: 'numeric', month: 'short' })}</td>
                            <td class="text-end text-success">₺${day.revenue.toFixed(2)}</td>
                            <td class="text-end text-danger">₺${day.commission.toFixed(2)}</td>
                            <td class="text-end text-primary fw-bold">₺${day.netAmount.toFixed(2)}</td>
                            <td class="text-end">${day.orderCount}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // Update footer totals
                document.getElementById('totalRevenueFoot').textContent = `₺${report.totalRevenue.toFixed(2)}`;
                document.getElementById('totalCommissionFoot').textContent = `₺${report.totalCommission.toFixed(2)}`;
                document.getElementById('totalNetFoot').textContent = `₺${report.netAmount.toFixed(2)}`;
                document.getElementById('totalOrdersFoot').textContent = report.totalOrders;

            } catch (error) {
                console.error('Error loading settlement report:', error);
            }
        }
    </script>
}
