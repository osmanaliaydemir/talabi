@inject ILocalizationService LocalizationService
@{
    ViewData["Title"] = LocalizationService.GetString("SalesDashboard");
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fas fa-chart-line"></i> @LocalizationService.GetString("SalesDashboard")</h3>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-download"></i> @LocalizationService.GetString("Export")
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportReport('excel')">
                <i class="fas fa-file-excel"></i> @LocalizationService.GetString("ExportToExcel")
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')">
                <i class="fas fa-file-pdf"></i> @LocalizationService.GetString("ExportToPdf")
            </a></li>
        </ul>
    </div>
</div>

<!-- Date Range Filter -->
<div class="stat-card mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">@LocalizationService.GetString("StartDate")</label>
            <input type="date" id="startDate" class="form-control" value="@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-md-3">
            <label class="form-label">@LocalizationService.GetString("EndDate")</label>
            <input type="date" id="endDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-getir w-100" onclick="loadDashboard()">
                <i class="fas fa-filter"></i> @LocalizationService.GetString("ApplyFilter")
            </button>
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                <i class="fas fa-undo"></i> @LocalizationService.GetString("Reset")
            </button>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4" id="summaryCards">
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="stat-icon bg-primary">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <h4 class="stat-value" id="totalRevenue">₺0</h4>
            <p class="stat-label">@LocalizationService.GetString("TotalRevenue")</p>
            <small class="text-success" id="revenueGrowth">+0%</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="stat-icon bg-success">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <h4 class="stat-value" id="totalOrders">0</h4>
            <p class="stat-label">@LocalizationService.GetString("TotalOrders")</p>
            <small class="text-success" id="orderGrowth">+0%</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="stat-icon bg-warning">
                <i class="fas fa-check-circle"></i>
            </div>
            <h4 class="stat-value" id="completedOrders">0</h4>
            <p class="stat-label">@LocalizationService.GetString("CompletedOrders")</p>
            <small class="text-muted" id="completionRate">0%</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="stat-icon bg-info">
                <i class="fas fa-chart-bar"></i>
            </div>
            <h4 class="stat-value" id="avgOrderValue">₺0</h4>
            <p class="stat-label">@LocalizationService.GetString("AverageOrderValue")</p>
            <small class="text-muted">@LocalizationService.GetString("PerOrder")</small>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Revenue Chart -->
    <div class="col-md-8">
        <div class="stat-card">
            <h5 class="mb-3">@LocalizationService.GetString("RevenueTrend")</h5>
            <canvas id="revenueChart" height="300"></canvas>
        </div>
    </div>
    
    <!-- Payment Methods Chart -->
    <div class="col-md-4">
        <div class="stat-card">
            <h5 class="mb-3">@LocalizationService.GetString("PaymentMethods")</h5>
            <canvas id="paymentMethodsChart" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Bottom Row -->
<div class="row">
    <!-- Top Products -->
    <div class="col-md-6">
        <div class="stat-card">
            <h5 class="mb-3">@LocalizationService.GetString("TopProducts")</h5>
            <div id="topProductsList">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin"></i> @LocalizationService.GetString("Loading")
                </div>
            </div>
        </div>
    </div>
    
    <!-- Category Breakdown -->
    <div class="col-md-6">
        <div class="stat-card">
            <h5 class="mb-3">@LocalizationService.GetString("CategoryBreakdown")</h5>
            <canvas id="categoryChart" height="300"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let revenueChart, paymentMethodsChart, categoryChart;

        $(document).ready(function() {
            loadDashboard();
        });

        function loadDashboard() {
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();
            
            showLoading();
            
            $.get('/Reports/GetSalesDashboard', { startDate, endDate })
                .done(function(response) {
                    if (response.success) {
                        updateSummaryCards(response.data);
                        updateCharts(response.data);
                        updateTopProducts(response.data.topProducts);
                    } else {
                        showError(response.message);
                    }
                })
                .fail(function() {
                    showError('@LocalizationService.GetString("ErrorLoadingData")');
                })
                .always(function() {
                    hideLoading();
                });
        }

        function updateSummaryCards(data) {
            $('#totalRevenue').text('₺' + data.totalRevenue.toLocaleString('tr-TR', { minimumFractionDigits: 2 }));
            $('#totalOrders').text(data.totalOrders.toLocaleString('tr-TR'));
            $('#completedOrders').text(data.completedOrders.toLocaleString('tr-TR'));
            $('#avgOrderValue').text('₺' + data.averageOrderValue.toLocaleString('tr-TR', { minimumFractionDigits: 2 }));
            
            $('#revenueGrowth').text((data.revenueGrowth >= 0 ? '+' : '') + data.revenueGrowth.toFixed(1) + '%');
            $('#orderGrowth').text((data.orderGrowth >= 0 ? '+' : '') + data.orderGrowth.toFixed(1) + '%');
            
            const completionRate = data.totalOrders > 0 ? (data.completedOrders / data.totalOrders * 100).toFixed(1) : 0;
            $('#completionRate').text(completionRate + '%');
        }

        function updateCharts(data) {
            // Revenue Chart
            if (revenueChart) revenueChart.destroy();
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: data.revenueByDay.map(d => new Date(d.date).toLocaleDateString('tr-TR')),
                    datasets: [{
                        label: '@LocalizationService.GetString("Revenue")',
                        data: data.revenueByDay.map(d => d.value),
                        borderColor: '#6f42c1',
                        backgroundColor: 'rgba(111, 66, 193, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₺' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });

            // Payment Methods Chart
            if (paymentMethodsChart) paymentMethodsChart.destroy();
            const paymentCtx = document.getElementById('paymentMethodsChart').getContext('2d');
            paymentMethodsChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: data.paymentMethodBreakdown.map(p => p.label),
                    datasets: [{
                        data: data.paymentMethodBreakdown.map(p => p.value),
                        backgroundColor: data.paymentMethodBreakdown.map(p => p.color)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Category Chart
            if (categoryChart) categoryChart.destroy();
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: data.categoryBreakdown.map(c => c.label),
                    datasets: [{
                        label: '@LocalizationService.GetString("Revenue")',
                        data: data.categoryBreakdown.map(c => c.value),
                        backgroundColor: '#28a745'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTopProducts(products) {
            const container = $('#topProductsList');
            if (products.length === 0) {
                container.html('<div class="text-center text-muted py-4">@LocalizationService.GetString("NoDataAvailable")</div>');
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            products.slice(0, 5).forEach((product, index) => {
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${product.productName}</h6>
                            <small class="text-muted">${product.quantitySold} @LocalizationService.GetString("Sold")</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary">₺${product.revenue.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.html(html);
        }

        function resetFilters() {
            $('#startDate').val('@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")');
            $('#endDate').val('@DateTime.Now.ToString("yyyy-MM-dd")');
            loadDashboard();
        }

        function exportReport(format) {
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();
            
            const request = {
                startDate: startDate,
                endDate: endDate,
                reportType: 'sales-dashboard',
                format: format
            };

            const url = format === 'excel' ? '/Reports/ExportToExcel' : '/Reports/ExportToPdf';
            
            $.post(url, JSON.stringify(request), function(data) {
                // Handle file download
                const blob = new Blob([data], { type: 'application/octet-stream' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sales_dashboard_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                a.click();
                window.URL.revokeObjectURL(url);
            }, 'arraybuffer');
        }

        function showLoading() {
            $('#summaryCards .stat-value').html('<i class="fas fa-spinner fa-spin"></i>');
        }

        function hideLoading() {
            // Loading will be replaced by actual data
        }

        function showError(message) {
            toastr.error(message);
        }
    </script>
}
