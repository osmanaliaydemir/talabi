@inject ILocalizationService LocalizationService
@{
    ViewData["Title"] = LocalizationService.GetString("RevenueAnalytics");
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fas fa-chart-line"></i> @LocalizationService.GetString("RevenueAnalytics")</h3>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-download"></i> @LocalizationService.GetString("Export")
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportReport('excel')">
                <i class="fas fa-file-excel"></i> @LocalizationService.GetString("ExportToExcel")
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')">
                <i class="fas fa-file-pdf"></i> @LocalizationService.GetString("ExportToPdf")
            </a></li>
        </ul>
    </div>
</div>

<!-- Date Range Filter -->
<div class="stat-card mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">@LocalizationService.GetString("StartDate")</label>
            <input type="date" id="startDate" class="form-control" value="@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-md-3">
            <label class="form-label">@LocalizationService.GetString("EndDate")</label>
            <input type="date" id="endDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-getir w-100" onclick="loadRevenueData()">
                <i class="fas fa-filter"></i> @LocalizationService.GetString("ApplyFilter")
            </button>
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                <i class="fas fa-undo"></i> @LocalizationService.GetString("Reset")
            </button>
        </div>
    </div>
</div>

<!-- Revenue Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="stat-card text-center">
            <div class="stat-icon bg-primary">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <h4 class="stat-value" id="totalRevenue">₺0</h4>
            <p class="stat-label">@LocalizationService.GetString("TotalRevenue")</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card text-center">
            <div class="stat-icon bg-success">
                <i class="fas fa-trending-up"></i>
            </div>
            <h4 class="stat-value" id="revenueTrend">+0%</h4>
            <p class="stat-label">@LocalizationService.GetString("RevenueTrend")</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card text-center">
            <div class="stat-icon bg-info">
                <i class="fas fa-chart-bar"></i>
            </div>
            <h4 class="stat-value" id="avgDailyRevenue">₺0</h4>
            <p class="stat-label">@LocalizationService.GetString("AverageDailyRevenue")</p>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <!-- Daily Revenue Chart -->
    <div class="col-md-8">
        <div class="stat-card">
            <h5 class="mb-3">@LocalizationService.GetString("DailyRevenue")</h5>
            <canvas id="dailyRevenueChart" height="300"></canvas>
        </div>
    </div>
    
    <!-- Payment Method Distribution -->
    <div class="col-md-4">
        <div class="stat-card">
            <h5 class="mb-3">@LocalizationService.GetString("PaymentMethodDistribution")</h5>
            <canvas id="paymentMethodChart" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Additional Charts -->
<div class="row">
    <!-- Revenue by Hour -->
    <div class="col-md-6">
        <div class="stat-card">
            <h5 class="mb-3">@LocalizationService.GetString("RevenueByHour")</h5>
            <canvas id="hourlyRevenueChart" height="250"></canvas>
        </div>
    </div>
    
    <!-- Top Revenue Days -->
    <div class="col-md-6">
        <div class="stat-card">
            <h5 class="mb-3">@LocalizationService.GetString("TopRevenueDays")</h5>
            <div id="topRevenueDaysList">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin"></i> @LocalizationService.GetString("Loading")
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let dailyRevenueChart, paymentMethodChart, hourlyRevenueChart;

        $(document).ready(function() {
            loadRevenueData();
        });

        function loadRevenueData() {
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();
            
            showLoading();
            
            $.get('/Reports/GetRevenueAnalytics', { startDate, endDate })
                .done(function(response) {
                    if (response.success) {
                        updateSummary(response.data);
                        updateCharts(response.data);
                        updateTopRevenueDays(response.data.topRevenueDays);
                    } else {
                        showError(response.message);
                    }
                })
                .fail(function() {
                    showError('@LocalizationService.GetString("ErrorLoadingData")');
                })
                .always(function() {
                    hideLoading();
                });
        }

        function updateSummary(data) {
            $('#totalRevenue').text('₺' + data.totalRevenue.toLocaleString('tr-TR', { minimumFractionDigits: 2 }));
            $('#revenueTrend').text((data.revenueTrend >= 0 ? '+' : '') + data.revenueTrend.toFixed(1) + '%');
            
            const avgDaily = data.dailyRevenue.length > 0 
                ? data.dailyRevenue.reduce((sum, day) => sum + day.value, 0) / data.dailyRevenue.length 
                : 0;
            $('#avgDailyRevenue').text('₺' + avgDaily.toLocaleString('tr-TR', { minimumFractionDigits: 2 }));
        }

        function updateCharts(data) {
            // Daily Revenue Chart
            if (dailyRevenueChart) dailyRevenueChart.destroy();
            const dailyCtx = document.getElementById('dailyRevenueChart').getContext('2d');
            dailyRevenueChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: data.dailyRevenue.map(d => new Date(d.date).toLocaleDateString('tr-TR')),
                    datasets: [{
                        label: '@LocalizationService.GetString("Revenue")',
                        data: data.dailyRevenue.map(d => d.value),
                        borderColor: '#6f42c1',
                        backgroundColor: 'rgba(111, 66, 193, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₺' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });

            // Payment Method Chart
            if (paymentMethodChart) paymentMethodChart.destroy();
            const paymentCtx = document.getElementById('paymentMethodChart').getContext('2d');
            paymentMethodChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: data.paymentMethodDistribution.map(p => p.label),
                    datasets: [{
                        data: data.paymentMethodDistribution.map(p => p.value),
                        backgroundColor: data.paymentMethodDistribution.map(p => p.color)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Hourly Revenue Chart
            if (hourlyRevenueChart) hourlyRevenueChart.destroy();
            const hourlyCtx = document.getElementById('hourlyRevenueChart').getContext('2d');
            hourlyRevenueChart = new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: data.revenueByHour.map(h => h.hour + ':00'),
                    datasets: [{
                        label: '@LocalizationService.GetString("Revenue")',
                        data: data.revenueByHour.map(h => h.value),
                        backgroundColor: '#28a745'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTopRevenueDays(days) {
            const container = $('#topRevenueDaysList');
            if (days.length === 0) {
                container.html('<div class="text-center text-muted py-4">@LocalizationService.GetString("NoDataAvailable")</div>');
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            days.slice(0, 5).forEach((day, index) => {
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${new Date(day.date).toLocaleDateString('tr-TR')}</h6>
                            <small class="text-muted">${day.count} @LocalizationService.GetString("Orders")</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success">₺${day.value.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.html(html);
        }

        function resetFilters() {
            $('#startDate').val('@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")');
            $('#endDate').val('@DateTime.Now.ToString("yyyy-MM-dd")');
            loadRevenueData();
        }

        function exportReport(format) {
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();
            
            const request = {
                startDate: startDate,
                endDate: endDate,
                reportType: 'revenue-analytics',
                format: format
            };

            const url = format === 'excel' ? '/Reports/ExportToExcel' : '/Reports/ExportToPdf';
            
            $.post(url, JSON.stringify(request), function(data) {
                const blob = new Blob([data], { type: 'application/octet-stream' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `revenue_analytics_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                a.click();
                window.URL.revokeObjectURL(url);
            }, 'arraybuffer');
        }

        function showLoading() {
            $('#totalRevenue, #revenueTrend, #avgDailyRevenue').html('<i class="fas fa-spinner fa-spin"></i>');
        }

        function hideLoading() {
            // Loading will be replaced by actual data
        }

        function showError(message) {
            toastr.error(message);
        }
    </script>
}
