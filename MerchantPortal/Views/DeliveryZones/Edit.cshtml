@inject ILocalizationService LocalizationService
@model Getir.MerchantPortal.Models.UpdateDeliveryZoneRequest

<h3>@LocalizationService.GetString("EditDeliveryZone")</h3>

<form asp-action="Edit" method="post">
	@Html.AntiForgeryToken()
	<input type="hidden" name="id" value="@ViewBag.ZoneId" />

	<div class="mb-3">
		<label class="form-label">@LocalizationService.GetString("Name")</label>
		<input asp-for="Name" class="form-control" />
	</div>
	<div class="mb-3">
		<label class="form-label">Polygon (GeoJSON)</label>
        <div id="map" style="height:300px;border:1px solid #ddd;border-radius:8px;margin-bottom:10px;"></div>
        <textarea asp-for="PolygonGeoJson" id="geoJsonBox" class="form-control" rows="5"></textarea>
	</div>
	<div class="row">
		<div class="col-md-6 mb-3">
			<label class="form-label">@LocalizationService.GetString("DeliveryFee")</label>
			<input asp-for="DeliveryFee" type="number" step="0.01" class="form-control" />
		</div>
		<div class="col-md-6 mb-3">
			<label class="form-label">@LocalizationService.GetString("Eta")</label>
			<input asp-for="EstimatedMinutes" type="number" class="form-control" />
		</div>
	</div>
	<div class="form-check mb-3">
		<input asp-for="IsActive" class="form-check-input" />
		<label class="form-check-label">@LocalizationService.GetString("Active")</label>
	</div>

	<button type="submit" class="btn btn-primary">@LocalizationService.GetString("Save")</button>
	<a class="btn btn-secondary" href="@Url.Action("Index")">@LocalizationService.GetString("Cancel")</a>
</form>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        (function(){
            const map = L.map('map').setView([41.015137, 28.979530], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            let points = [];
            const box = document.getElementById('geoJsonBox');
            try{
                if(box.value){
                    const gj = JSON.parse(box.value);
                    const coords = gj.geometry?.coordinates?.[0] ?? [];
                    points = coords.map(c => [c[1], c[0]]);
                }
            }catch{}
            let poly = null;
            if(points.length){ poly = L.polygon(points, {color:'purple'}).addTo(map); map.fitBounds(poly.getBounds()); }
            map.on('click', function(e){
                points.push([e.latlng.lat, e.latlng.lng]);
                if(poly){ poly.remove(); }
                poly = L.polygon(points, {color:'purple'}).addTo(map);
                const gj = { type:'Feature', geometry:{ type:'Polygon', coordinates:[ points.map(p => [p[1], p[0]]) ] }, properties:{} };
                box.value = JSON.stringify(gj);
            });
        })();
    </script>
}


