@inject ILocalizationService LocalizationService
@model Getir.MerchantPortal.Models.MerchantDocumentsViewModel

@{
	var statusOptions = ViewBag.StatusOptions as string[] ?? Array.Empty<string>();
	var documentTypes = Model.RequiredTypes.Select(t => t.Type).Distinct().OrderBy(t => t).ToList();
}

<div class="d-flex justify-content-between align-items-center mb-4">
	<div>
		<h3 class="mb-0">@LocalizationService.GetString("Documents")</h3>
		@if (Model.Progress != null)
		{
			<p class="text-muted mb-0 small">
				@LocalizationService.GetString("Completion") :
				<strong>@Model.Progress.CompletionPercentage.ToString("P0")</strong>
				(@Model.Progress.UploadedDocuments / @Model.Progress.TotalRequiredDocuments)
			</p>
		}
	</div>
	<div class="d-flex gap-2">
		@if (Model.IsAdmin)
		{
			<a class="btn btn-outline-secondary" href="@Url.Action("Pending")">
				<i class="fas fa-user-check me-1"></i> İnceleme Bekleyenler
			</a>
		}
		<a class="btn btn-primary" href="@Url.Action("Upload", new { merchantId = Model.MerchantId })">
			<i class="fas fa-upload me-1"></i> @LocalizationService.GetString("Upload")
		</a>
	</div>
</div>

<div class="card mb-4">
	<div class="card-body">
		<form class="row gy-2 gx-3 align-items-end" method="get">
			<div class="col-md-4">
				<label class="form-label">@LocalizationService.GetString("Status")</label>
				<select class="form-select" name="status">
					<option value="">@LocalizationService.GetString("All")</option>
					@foreach (var option in statusOptions)
					{
						<option value="@option" selected="@(option.Equals(Model.SelectedStatus, StringComparison.OrdinalIgnoreCase))">@option</option>
					}
				</select>
			</div>
			<div class="col-md-4">
				<label class="form-label">@LocalizationService.GetString("Type")</label>
				<select class="form-select" name="documentType">
					<option value="">@LocalizationService.GetString("All")</option>
					@foreach (var option in documentTypes)
					{
						<option value="@option" selected="@(option.Equals(Model.SelectedDocumentType, StringComparison.OrdinalIgnoreCase))">@option</option>
					}
				</select>
			</div>
			<div class="col-md-4 d-flex align-items-end gap-2">
				<button type="submit" class="btn btn-primary">@LocalizationService.GetString("Filter")</button>
				<a href="@Url.Action("Index")" class="btn btn-outline-secondary">@LocalizationService.GetString("Reset")</a>
			</div>
		</form>
	</div>
</div>

@if (Model.Statistics != null && Model.IsAdmin)
{
	<div class="row row-cols-1 row-cols-md-4 g-3 mb-4">
		<div class="col">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-body">
					<div class="text-muted small">@LocalizationService.GetString("Total")</div>
					<div class="fw-semibold fs-4">@Model.Statistics.TotalDocuments</div>
				</div>
			</div>
		</div>
		<div class="col">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-body">
					<div class="text-muted small">Bekleyen</div>
					<div class="fw-semibold fs-4 text-warning">@Model.Statistics.PendingDocuments</div>
				</div>
			</div>
		</div>
		<div class="col">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-body">
					<div class="text-muted small">Onaylanan</div>
					<div class="fw-semibold fs-4 text-success">@Model.Statistics.ApprovedDocuments</div>
				</div>
			</div>
		</div>
		<div class="col">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-body">
					<div class="text-muted small">Reddedilen</div>
					<div class="fw-semibold fs-4 text-danger">@Model.Statistics.RejectedDocuments</div>
				</div>
			</div>
		</div>
	</div>
}

@if (Model.Documents.Items.Any())
{
	<div class="table-responsive">
		<table class="table table-striped align-middle">
			<thead class="table-light">
				<tr>
					<th>@LocalizationService.GetString("Type")</th>
					<th>@LocalizationService.GetString("File")</th>
					<th>Durum</th>
					<th class="text-center">Onay</th>
					<th>@LocalizationService.GetString("UploadedAt")</th>
					<th class="text-end">@LocalizationService.GetString("Actions")</th>
				</tr>
			</thead>
			<tbody>
			@foreach (var d in Model.Documents.Items)
			{
				var statusBadge = d.Status switch
				{
					"Approved" => "bg-success",
					"Rejected" => "bg-danger",
					"Expired" => "bg-secondary",
					_ => "bg-warning text-dark"
				};
				<tr>
					<td>
						<div class="fw-semibold">@d.DocumentType</div>
						@if (!string.IsNullOrWhiteSpace(d.DocumentName))
						{
							<div class="text-muted small">@d.DocumentName</div>
						}
					</td>
					<td>
						<div class="fw-semibold">@d.FileName</div>
						@if (d.FileSize > 0)
						{
							<div class="text-muted small">@((d.FileSize / 1024d).ToString("N1")) KB</div>
						}
					</td>
					<td>
						<span class="badge @statusBadge">@d.Status</span>
					</td>
					<td class="text-center">
						@if (d.IsApproved)
						{
							<i class="fas fa-check-circle text-success" title="Onaylandı"></i>
						}
						else if (d.IsVerified)
						{
							<i class="fas fa-user-check text-info" title="Doğrulandı"></i>
						}
						else
						{
							<i class="fas fa-hourglass-half text-warning" title="Beklemede"></i>
						}
					</td>
					<td>@d.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
					<td class="text-end">
						<div class="btn-group btn-group-sm">
							<a class="btn btn-outline-primary" href="@Url.Action("Details", new { id = d.Id })">
								<i class="fas fa-eye"></i>
							</a>
							<a class="btn btn-outline-secondary" href="@Url.Action("Download", new { id = d.Id })">
								<i class="fas fa-download"></i>
							</a>
							<form asp-action="Delete" method="post" class="d-inline" onsubmit="return confirm('Silinsin mi?');">
								@Html.AntiForgeryToken()
								<input type="hidden" name="id" value="@d.Id" />
								<button type="submit" class="btn btn-outline-danger">
									<i class="fas fa-trash"></i>
								</button>
							</form>
						</div>
					</td>
				</tr>
			}
			</tbody>
		</table>
	</div>
}
else
{
	<div class="alert alert-info">@LocalizationService.GetString("NoData")</div>
}

