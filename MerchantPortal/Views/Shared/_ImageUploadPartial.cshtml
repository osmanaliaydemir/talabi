@inject ILocalizationService LocalizationService
@using Getir.MerchantPortal.Services
@* Image Upload Component with Drag & Drop, Compression, and Multiple Files *@

<div class="image-upload-section">
    <!-- Drag & Drop Zone -->
    <div class="drag-drop-zone" id="imageDropZone">
        <div class="drop-zone-content">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
            <h5>@LocalizationService.GetString("ImageUploadTitle")</h5>
            <p class="text-muted mb-0">@LocalizationService.GetString("ImageUploadHint").Replace("{0}", "5").Replace("{1}", "5")</p>
            <small class="text-muted">@LocalizationService.GetString("ImageAutoCompress")</small>
        </div>
    </div>

    <!-- Image Previews -->
    <div class="image-previews-container" id="imagePreviews">
        <!-- Preview items will be added here by JS -->
    </div>

    <!-- Upload Progress -->
    <div class="upload-progress-container" id="uploadProgress" style="display: none;">
        <h6 class="mb-3">
            <i class="fas fa-spinner fa-spin me-2"></i>
            @LocalizationService.GetString("Uploading")
        </h6>
        <div id="progressItems"></div>
    </div>
</div>

@section Styles {
    <style>
        .drag-drop-zone {
            border: 3px dashed #dee2e6;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            margin-bottom: 1.5rem;
        }
        .drag-drop-zone:hover,
        .drag-drop-zone.drag-over {
            border-color: #5D3EBC;
            background: rgba(93, 62, 188, 0.05);
            transform: scale(1.02);
        }
        .image-previews-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .image-preview-item.main-image {
            border-color: #FFD300;
            box-shadow: 0 0 0 3px rgba(255, 211, 0, 0.2);
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .main-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #FFD300;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .preview-actions {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .image-preview-item:hover .preview-actions {
            opacity: 1;
        }
        .preview-order {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.6);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .upload-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .upload-item .upload-info {
            flex: 1;
        }
        .upload-item.upload-success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .upload-item.upload-error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
}

@section Scripts {
    <script src="~/js/modules/upload/dragDrop.js" asp-append-version="true"></script>
    <script src="~/js/modules/upload/imageCompression.js" asp-append-version="true"></script>
    <script src="~/js/modules/upload/multipleFiles.js" asp-append-version="true"></script>
    <script src="~/js/modules/upload/uploadProgress.js" asp-append-version="true"></script>

    <script>
        let uploader, compressor, fileManager, progressTracker;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modules
            uploader = new DragDropUploader('imageDropZone', {
                maxFiles: 5,
                maxFileSize: 5 * 1024 * 1024,
                acceptedTypes: ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'],
                onFilesAdded: handleFilesAdded,
                onError: (msg) => alert(msg)
            });

            compressor = new ImageCompressor({
                maxWidth: 1920,
                maxHeight: 1080,
                quality: 0.85
            });

            fileManager = new MultipleFilesManager('imagePreviews', {
                maxFiles: 5,
                onFilesChanged: (files) => console.log('Files changed:', files.length),
                onMainImageChanged: (index) => console.log('Main image:', index)
            });

            progressTracker = new UploadProgressTracker('progressItems');

            // Make fileManager global for removeImage/setMainImage functions
            window.fileManager = fileManager;
        });

        async function handleFilesAdded(files) {
            document.getElementById('uploadProgress').style.display = 'block';

            for (const file of files) {
                const fileId = `file-${Date.now()}-${Math.random()}`;
                
                try {
                    // Start progress tracking
                    progressTracker.startUpload(fileId, file.name, file.size);

                    // Compress image
                    const compressedBlob = await compressor.compressImage(file);
                    
                    // Simulate upload progress (in real scenario, use XHR with progress events)
                    await simulateUploadProgress(fileId, compressedBlob.size);

                    // Add to file manager
                    const compressedFile = new File([compressedBlob], file.name, {
                        type: compressedBlob.type
                    });
                    fileManager.addFiles([compressedFile]);

                    // Complete progress
                    progressTracker.completeUpload(fileId, true);

                } catch (error) {
                    console.error('Upload error:', error);
                    progressTracker.completeUpload(fileId, false);
                }
            }

            setTimeout(() => {
                document.getElementById('uploadProgress').style.display = 'none';
            }, 2000);
        }

        // Simulate upload progress (replace with real XHR in production)
        function simulateUploadProgress(fileId, fileSize) {
            return new Promise((resolve) => {
                let loaded = 0;
                const interval = setInterval(() => {
                    loaded += fileSize / 20; // 20 steps
                    if (loaded >= fileSize) {
                        loaded = fileSize;
                        clearInterval(interval);
                        resolve();
                    }
                    progressTracker.updateProgress(fileId, loaded, fileSize);
                }, 50);
            });
        }

        // Get files for form submission
        function getUploadedFiles() {
            return fileManager ? fileManager.getFiles() : [];
        }

        // Get main image
        function getMainImage() {
            return fileManager ? fileManager.getMainImage() : null;
        }
    </script>
}

