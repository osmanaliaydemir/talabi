@inject Talabi.Portal.Services.ILocalizationService LocalizationService
@{
    ViewData["Title"] = LocalizationService.GetString("Orders");
}

<div class="container-fluid p-0">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="h3 mb-0 text-gray-800">@LocalizationService.GetString("Orders")</h1>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">@LocalizationService.GetString("Filter")</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">@LocalizationService.GetString("Status")</label>
                    <select id="filterStatus" class="form-select">
                        <option value="">@LocalizationService.GetString("All")</option>
                        <option value="Pending">@LocalizationService.GetString("Pending")</option>
                        <option value="Preparing">@LocalizationService.GetString("Preparing")</option>
                        <option value="Ready">@LocalizationService.GetString("Ready")</option>
                        <option value="Delivered">@LocalizationService.GetString("Delivered")</option>
                        <option value="Cancelled">@LocalizationService.GetString("Cancelled")</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" onclick="refreshTable()">
                        <i class="fas fa-filter me-1"></i> @LocalizationService.GetString("Apply")
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="ordersTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>@LocalizationService.GetString("OrderId")</th>
                            <th>@LocalizationService.GetString("Customer")</th>
                            <th>@LocalizationService.GetString("Date")</th>
                            <th>@LocalizationService.GetString("Amount")</th>
                            <th>@LocalizationService.GetString("Status")</th>
                            <th>@LocalizationService.GetString("Actions")</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@LocalizationService.GetString("OrderDetails") <span id="modalOrderId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>@LocalizationService.GetString("Customer"):</strong> <span id="detailCustomer"></span><br>
                        <strong>@LocalizationService.GetString("Phone"):</strong> <span id="detailPhone"></span>
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>@LocalizationService.GetString("Date"):</strong> <span id="detailDate"></span><br>
                        <strong>@LocalizationService.GetString("Address"):</strong> <span id="detailAddress"></span>
                    </div>
                </div>
                
                <h6 class="mt-4">@LocalizationService.GetString("Products")</h6>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>@LocalizationService.GetString("Product")</th>
                            <th class="text-center">@LocalizationService.GetString("Quantity")</th>
                            <th class="text-end">@LocalizationService.GetString("Price")</th>
                            <th class="text-end">@LocalizationService.GetString("Total")</th>
                        </tr>
                    </thead>
                    <tbody id="orderItemsBody"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end fw-bold">@LocalizationService.GetString("TotalAmount"):</td>
                            <td class="text-end fw-bold" id="detailTotalAmount"></td>
                        </tr>
                    </tfoot>
                </table>

                <div class="mt-3">
                    <label class="form-label">@LocalizationService.GetString("UpdateStatus")</label>
                    <select id="updateStatusSelect" class="form-select w-auto d-inline-block">
                         <option value="0">@LocalizationService.GetString("Pending")</option>
                         <option value="1">@LocalizationService.GetString("Preparing")</option>
                         <option value="2">@LocalizationService.GetString("Ready")</option>
                         <option value="3">@LocalizationService.GetString("Delivered")</option>
                         <option value="4">@LocalizationService.GetString("Cancelled")</option>
                    </select>
                    <button class="btn btn-primary" onclick="updateOrderStatus()">@LocalizationService.GetString("Update")</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@LocalizationService.GetString("Close")</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let dataTable;
        let orderModal;
        let currentOrderId = null;

        const StatusEnum = {
            0: 'Pending',
            1: 'Preparing',
            2: 'Ready',
            3: 'Delivered',
            4: 'Cancelled',
            5: 'Assigned',
            6: 'Accepted',
            7: 'OutForDelivery'
        };

        const StatusColors = {
            0: 'warning',
            1: 'info',
            2: 'primary',
            3: 'success',
            4: 'danger',
            5: 'info',
            6: 'info',
            7: 'info'
        };

        $(document).ready(function() {
            orderModal = new bootstrap.Modal(document.getElementById('orderModal'));
            initDataTable();
        });

        function initDataTable() {
            dataTable = $('#ordersTable').DataTable({
                serverSide: true,
                processing: true,
                ajax: {
                    url: '/Orders/GetList',
                    type: 'GET',
                    data: function(d) {
                        d.status = $('#filterStatus').val();
                    }
                },
                columns: [
                    { data: 'customerOrderId', name: 'customerOrderId' },
                    { data: 'customerName', name: 'customerName' },
                    { 
                        data: 'createdAt', 
                        name: 'createdAt',
                        render: function(data) {
                            return new Date(data).toLocaleString();
                        }
                    },
                    { 
                        data: 'totalAmount', 
                        name: 'totalAmount',
                        render: function(data) {
                            return data.toFixed(2); // + Currency symbol if needed
                        }
                    },
                    { 
                        data: 'status', 
                        name: 'status',
                        render: function(data) {
                            const statusText = StatusEnum[data] || data;
                            const color = StatusColors[data] || 'secondary';
                            return `<span class="badge bg-${color}">${statusText}</span>`;
                        }
                    },
                    {
                        data: 'id',
                        orderable: false,
                        render: function(data) {
                            return `
                                <button class="btn btn-sm btn-outline-primary" onclick="viewOrder('${data}')" title="@LocalizationService.GetString("View")">
                                    <i class="fas fa-eye"></i>
                                </button>
                            `;
                        }
                    }
                ],
                order: [[2, 'desc']], 
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/' + ('@System.Globalization.CultureInfo.CurrentCulture.Name' === 'tr-TR' ? 'tr' : 'en-GB') + '.json'
                }
            });
        }

        function refreshTable() {
            dataTable.ajax.reload();
        }

        function viewOrder(id) {
            currentOrderId = id;
            $.get('/Orders/Get/' + id, function(data) {
                $('#modalOrderId').text('#' + data.customerOrderId);
                $('#detailCustomer').text(data.customerName);
                $('#detailPhone').text(data.customerPhone || '-');
                $('#detailDate').text(new Date(data.createdAt).toLocaleString());
                $('#detailAddress').text(data.deliveryAddress || '-');
                $('#detailTotalAmount').text(data.totalAmount.toFixed(2));
                
                $('#updateStatusSelect').val(data.status);

                const tbody = $('#orderItemsBody');
                tbody.empty();
                data.items.forEach(item => {
                    tbody.append(`
                        <tr>
                            <td>${item.productName}</td>
                            <td class="text-center">${item.quantity}</td>
                            <td class="text-end">${item.unitPrice.toFixed(2)}</td>
                            <td class="text-end">${item.totalPrice.toFixed(2)}</td>
                        </tr>
                    `);
                });

                orderModal.show();
            });
        }

        function updateOrderStatus() {
            if(!currentOrderId) return;
            const newStatus = $('#updateStatusSelect').val();

            $.post('/Orders/UpdateStatus', { id: currentOrderId, status: newStatus }, function(response) {
                if(response.success) {
                    orderModal.hide();
                    refreshTable();
                     Swal.fire({
                        icon: 'success',
                        title: '@LocalizationService.GetString("Success")',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    Swal.fire('Hata', response.message, 'error');
                }
            });
        }
    </script>
}
