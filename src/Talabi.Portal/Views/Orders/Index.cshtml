@inject Talabi.Portal.Services.ILocalizationService LocalizationService
@{
    ViewData["Title"] = LocalizationService.GetString("Orders");
}

<div class="container-fluid p-0">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="h3 mb-0 text-gray-800">@LocalizationService.GetString("Orders")</h1>
        </div>
    </div>

    <!-- Status Tabs -->
    <div class="d-flex overflow-auto pb-3 mb-3">
        <ul class="nav nav-pills flex-nowrap">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-status="" onclick="switchTab(this, '')">
                    <i class="fas fa-th-large me-2"></i>@LocalizationService.GetString("All")
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-status="Pending" onclick="switchTab(this, 'Pending')">
                    <i class="fas fa-clock me-2"></i>@LocalizationService.GetString("Pending")
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-status="Preparing" onclick="switchTab(this, 'Preparing')">
                    <i class="fas fa-fire me-2"></i>@LocalizationService.GetString("Preparing")
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-status="Ready" onclick="switchTab(this, 'Ready')">
                    <i class="fas fa-check-circle me-2"></i>@LocalizationService.GetString("Ready")
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-status="Assigned" onclick="switchTab(this, 'Assigned')">
                    <i class="fas fa-motorcycle me-2"></i>@LocalizationService.GetString("Assigned")
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-status="OutForDelivery" onclick="switchTab(this, 'OutForDelivery')">
                    <i class="fas fa-route me-2"></i>@LocalizationService.GetString("OutForDelivery")
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-status="Delivered" onclick="switchTab(this, 'Delivered')">
                    <i class="fas fa-home me-2"></i>@LocalizationService.GetString("Delivered")
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-status="Cancelled" onclick="switchTab(this, 'Cancelled')">
                    <i class="fas fa-times-circle me-2"></i>@LocalizationService.GetString("Cancelled")
                </a>
            </li>
        </ul>
    </div>

    <input type="hidden" id="filterStatus" value="">

    <!-- Filters (Collapsible if needed, but keeping visible for Date/Amount) -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body bg-light rounded-3">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label text-muted small fw-bold text-uppercase">@LocalizationService.GetString("StartDate")</label>
                    <input type="date" id="filterStartDate" class="form-control border-0 shadow-sm">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted small fw-bold text-uppercase">@LocalizationService.GetString("EndDate")</label>
                    <input type="date" id="filterEndDate" class="form-control border-0 shadow-sm">
                </div>
                <div class="col-md-2">
                    <label class="form-label text-muted small fw-bold text-uppercase">@LocalizationService.GetString("MinAmount")</label>
                    <input type="number" id="filterMinAmount" class="form-control border-0 shadow-sm" placeholder="0.00" step="0.01">
                </div>
                <div class="col-md-2">
                    <label class="form-label text-muted small fw-bold text-uppercase">@LocalizationService.GetString("MaxAmount")</label>
                    <input type="number" id="filterMaxAmount" class="form-control border-0 shadow-sm" placeholder="0.00" step="0.01">
                </div>
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button class="btn btn-primary w-100 shadow-sm" onclick="refreshTable()">
                        <i class="fas fa-filter me-1"></i> @LocalizationService.GetString("Apply")
                    </button>
                    <button class="btn btn-light shadow-sm" onclick="clearFilters()" title="@LocalizationService.GetString("ClearFilters")">
                        <i class="fas fa-times text-muted"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders List Container -->
    <div id="ordersContainer" class="row">
        <!-- Content loaded via JS -->
    </div>
    
    <!-- Loading/Pagination -->
    <div class="text-center my-4">
        <div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display:none;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <button id="loadMoreBtn" class="btn btn-outline-primary px-4 py-2 rounded-pill shadow-sm" onclick="loadMore()" style="display:none;">
            @LocalizationService.GetString("LoadMore")
        </button>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let isLoading = false;
        let hasMore = true;

        const StatusEnum = {
            0: 'Pending',
            1: 'Preparing',
            2: 'Ready',
            3: 'Delivered',
            4: 'Cancelled',
            5: 'Assigned',
            6: 'Accepted',
            7: 'OutForDelivery'
        };
        
        // Match Mobile Colors
        const StatusColors = {
            'Pending': '#673ab7', // Deep Purple
            'Preparing': '#2196f3',
            'Ready': '#4caf50',
            'Assigned': '#ff9800', // Orange
            'Accepted': '#ff9800',
            'OutForDelivery': '#ff9800',
            'Delivered': '#9e9e9e',
            'Cancelled': '#f44336'
        };

        $(document).ready(function() {
            loadOrders(true);
        });

        function switchTab(element, status) {
            // Remove active class from all tabs
            $('.nav-link').removeClass('active');
            // Add active class to clicked tab
            $(element).addClass('active');
            
            // Set filter
            $('#filterStatus').val(status);
            
            // Refresh
            refreshTable();
        }

        function getStatusColor(statusStr) {
             return StatusColors[statusStr] || '#9e9e9e';
        }

        function loadOrders(reset = false) {
            if (isLoading) return;
            if (reset) {
                currentPage = 1;
                hasMore = true;
                $('#ordersContainer').empty();
            }

            isLoading = true;
            $('#loadingSpinner').show();
            $('#loadMoreBtn').hide();

            const params = {
                draw: 1, // Dummy for datatable compat
                start: (currentPage - 1) * pageSize,
                length: pageSize,
                status: $('#filterStatus').val(),
                startDate: $('#filterStartDate').val(),
                endDate: $('#filterEndDate').val(),
                minAmount: $('#filterMinAmount').val(),
                maxAmount: $('#filterMaxAmount').val()
            };

            $.ajax({
                url: '/Orders/GetList',
                type: 'GET',
                data: params,
                success: function(response) {
                    const data = response.data;
                    if (data.length < pageSize) hasMore = false;
                    
                    if (data.length === 0 && currentPage === 1) {
                         $('#ordersContainer').html(`
                            <div class="col-12 text-center py-5">
                                <div class="text-muted opacity-50">
                                    <i class="fas fa-box-open fa-4x mb-3"></i>
                                    <h5>@LocalizationService.GetString("NoOrdersYetShort")</h5>
                                </div>
                            </div>
                         `);
                    } else {
                        data.forEach(order => {
                            const statusStr = StatusEnum[order.status] || 'Pending';
                            const color = getStatusColor(statusStr);
                            // Using rgba for bg with 0.1 opacity
                            const bgStyle = `background-color: ${color}1A; color: ${color};`;
                            
                            const dateStr = new Date(order.createdAt).toLocaleString();
                            const amountStr = order.totalAmount.toFixed(2);

                            const cardHtml = `
                                <div class="col-12 mb-3">
                                    <div class="card border-0 shadow-sm h-100 order-card" onclick="window.location.href='/Orders/Details/${order.id}'">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0 me-3">
                                                    <div class="avatar-circle d-flex align-items-center justify-content-center text-white shadow-sm" 
                                                         style="width: 50px; height: 50px; border-radius: 50%; background-color: ${color}">
                                                        <i class="fas fa-receipt"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <h6 class="fw-bold mb-1">@LocalizationService.GetString("Order") #${order.customerOrderId || order.id}</h6>
                                                            <div class="text-muted small mb-1">
                                                                <i class="fas fa-user me-1"></i> ${order.customerName}
                                                            </div>
                                                            <div class="text-muted small">
                                                                <i class="far fa-clock me-1"></i> ${dateStr}
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <div class="h5 fw-bold text-dark mb-1">${amountStr} â‚º</div>
                                                            <span class="badge rounded-pill" style="${bgStyle}">${statusStr}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="ms-3">
                                                    <i class="fas fa-chevron-right text-muted opacity-50"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            $('#ordersContainer').append(cardHtml);
                        });
                    }

                    currentPage++;
                    isLoading = false;
                    $('#loadingSpinner').hide();
                    if (hasMore) $('#loadMoreBtn').show();
                },
                error: function() {
                    isLoading = false;
                    $('#loadingSpinner').hide();
                    Swal.fire('Error', 'Failed to load orders', 'error');
                }
            });
        }

        function loadMore() {
            if(hasMore) loadOrders();
        }

        function refreshTable() {
            loadOrders(true);
        }

        function clearFilters() {
            // Reset date/amount but keep current tab status
            $('#filterStartDate').val('');
            $('#filterEndDate').val('');
            $('#filterMinAmount').val('');
            $('#filterMaxAmount').val('');
            refreshTable();
        }
    </script>
    
    <style>
        .order-card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border-radius: 1rem !important;
        }
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
        }
        
        /* Modern Scrollbar for tabs container */
        .overflow-auto::-webkit-scrollbar {
            height: 4px;
        }
        .overflow-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .overflow-auto::-webkit-scrollbar-thumb {
            background: #dadada; 
            border-radius: 4px;
        }
        .overflow-auto::-webkit-scrollbar-thumb:hover {
            background: #c1c1c1; 
        }

        /* Modern Tabs / Pills */
        .nav-pills {
            gap: 0.5rem;
        }
        .nav-pills .nav-link {
            color: #6c757d;
            background-color: #f8f9fa;
            border: 1px solid #eaecf4;
            border-radius: 50rem;
            padding: 0.6rem 1.25rem;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .nav-pills .nav-link:hover {
            background-color: #eaecf4;
            color: #5a5c69;
        }
        .nav-pills .nav-link.active {
            background-color: #4e73df;
            color: #fff;
            border-color: #4e73df;
            box-shadow: 0 4px 12px rgba(78, 115, 223, 0.3);
            transform: translateY(-1px);
        }
        .nav-pills .nav-link i {
            font-size: 0.9em;
            opacity: 0.8;
        }
    </style>
}
